<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gidatech Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; margin: 0; padding: 20px; color: #1f2937; }
        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); text-align: center; }
        .login-container h2 { margin-top: 0; color: #111827; }
        .dashboard { display: none; max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; min-height: 80vh; }
        .header { background: #111827; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 1.25rem; }
        .nav { background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; gap: 2px; padding: 0 20px; overflow-x: auto; }
        .nav button { padding: 15px 20px; background: transparent; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280; font-size: 0.95rem; white-space: nowrap; }
        .nav button:hover { color: #111827; }
        .nav button.active { border-bottom-color: #111827; color: #111827; }
        .content-area { padding: 30px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        input[type="text"], input[type="password"], input[type="email"], textarea { width: 100%; padding: 10px; margin: 8px 0 20px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        label { font-weight: 600; font-size: 0.875rem; display: block; margin-bottom: 4px; color: #374151; }
        .btn { background: #111827; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
        .btn:hover { background: #000; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #fff; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #f9fafb; }
        .item-list { display: flex; flex-direction: column; gap: 15px; }
        .item-card { border: 1px solid #e5e7eb; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 20px; background: #fff; }
        .item-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #eee; }
        .item-details { flex-grow: 1; }
        .item-details h4 { margin: 0 0 5px 0; }
        .item-details p { margin: 0; color: #6b7280; font-size: 0.85rem; }
        .actions { display: flex; gap: 10px; }
        .content-row { display: grid; grid-template-columns: 1fr 2fr auto; gap: 20px; align-items: start; border-bottom: 1px solid #f3f4f6; padding: 20px 0; }
        .content-key { font-family: monospace; color: #6b7280; font-size: 0.85rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        .badge { padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-tuya { background: #e0f2fe; color: #0369a1; }
        .badge-orvibo { background: #fef3c7; color: #b45309; }

        /* Media Manager Styles */
        .media-level-tabs { display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid #e5e7eb; }
        .media-level-tab { padding: 10px 24px; background: transparent; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #9ca3af; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
        .media-level-tab:hover { color: #374151; }
        .media-level-tab.active { color: #111827; border-bottom-color: #111827; }
        .media-group { display: none; }
        .media-group.active { display: block; }
        .sub-tabs { display: flex; gap: 4px; padding: 12px 0; flex-wrap: wrap; }
        .sub-tab { padding: 6px 14px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 500; color: #6b7280; transition: all 0.2s; }
        .sub-tab:hover { background: #e5e7eb; color: #374151; }
        .sub-tab.active { background: #111827; color: white; border-color: #111827; }
        .media-sub { display: none; }
        .media-sub.active { display: block; }
        .media-slot { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px; display: flex; gap: 20px; align-items: center; background: #fafafa; transition: box-shadow 0.2s; }
        .media-slot:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .media-slot-preview { width: 140px; height: 90px; border-radius: 6px; overflow: hidden; background: #e5e7eb; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .media-slot-preview img, .media-slot-preview video { width: 100%; height: 100%; object-fit: cover; }
        .media-slot-preview .no-media { font-size: 0.7rem; color: #9ca3af; text-align: center; padding: 8px; }
        .media-slot-info { flex-grow: 1; }
        .media-slot-label { font-weight: 600; font-size: 0.9rem; color: #111827; margin-bottom: 4px; }
        .media-slot-key { font-family: monospace; font-size: 0.75rem; color: #9ca3af; margin-bottom: 8px; }
        .media-slot-actions { display: flex; gap: 8px; align-items: center; }
        .media-slot-actions input[type="file"] { margin: 0; padding: 0; font-size: 0.8rem; max-width: 200px; }
        .media-info-note { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 14px 18px; color: #1e40af; font-size: 0.85rem; margin-bottom: 16px; }
        .media-info-note strong { font-weight: 600; }
        .replace-btn { background: #111827; color: white; padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; }
        .replace-btn:hover { background: #000; }
        .replace-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .content-row { grid-template-columns: 1fr; }
            .item-card { flex-direction: column; align-items: flex-start; }
            .nav { padding-bottom: 10px; }
            .media-slot { flex-direction: column; align-items: stretch; }
            .media-slot-preview { width: 100%; height: 160px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-view" class="login-container">
        <h2>Admin Login</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="btn" style="width:100%">Sign In</button>
            <p id="login-error" style="color: #ef4444; margin-top: 15px; font-size: 0.9rem;"></p>
        </form>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view" class="dashboard">
        <header class="header">
            <h1>Gidatech CMS</h1>
            <button id="logout-btn" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;">Logout</button>
        </header>
        
        <nav class="nav">
            <button class="nav-btn active" onclick="switchTab('content')">Site Content</button>
            <button class="nav-btn" onclick="switchTab('projects')">Projects</button>
            <button class="nav-btn" onclick="switchTab('team')">Team</button>
            <button class="nav-btn" onclick="switchTab('media')">Media</button>
            <button class="nav-btn" onclick="switchTab('leads')">Leads & Downloads</button>
        </nav>

        <div class="content-area">
            
            <!-- TAB: SITE CONTENT -->
            <div id="tab-content" class="tab-pane active">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3>Edit Titles & Text</h3>
                    <button class="btn btn-secondary" onclick="loadContent()">Refresh</button>
                </div>
                <div id="content-list">Loading...</div>
            </div>

            <!-- TAB: PROJECTS -->
            <div id="tab-projects" class="tab-pane">
                <h3>Manage Projects</h3>
                <div style="background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:30px; border:1px solid #e5e7eb;">
                    <h4 style="margin-top:0;">Add New Project</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <input type="text" id="p-title" placeholder="Project Title">
                        <input type="text" id="p-desc" placeholder="Short Description">
                    </div>
                    <input type="text" id="p-link" placeholder="Link (e.g., # or https://...)">
                    <label>Project Image</label>
                    <input type="file" id="p-file" accept="image/*">
                    <button id="add-project-btn" class="btn">Add Project</button>
                </div>
                <div id="project-list" class="item-list">Loading...</div>
            </div>

            <!-- TAB: TEAM -->
            <div id="tab-team" class="tab-pane">
                <h3>Manage Team</h3>
                <div style="background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:30px; border:1px solid #e5e7eb;">
                    <h4 style="margin-top:0;">Add Team Member</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <input type="text" id="t-name" placeholder="Full Name">
                        <input type="text" id="t-role" placeholder="Role / Position">
                    </div>
                    <label>Profile Photo</label>
                    <input type="file" id="t-file" accept="image/*">
                    <button id="add-team-btn" class="btn">Add Member</button>
                </div>
                <div id="team-list" class="item-list">Loading...</div>
            </div>

            <!-- TAB: MEDIA -->
            <div id="tab-media" class="tab-pane">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">Media Manager</h3>
                    <button class="btn btn-secondary" onclick="loadMediaRegistry()">Refresh</button>
                </div>

                <div class="media-level-tabs">
                    <button class="media-level-tab active" onclick="switchMediaGroup('homepage')">Homepage</button>
                    <button class="media-level-tab" onclick="switchMediaGroup('pages')">Pages</button>
                </div>

                <!-- HOMEPAGE -->
                <div id="media-group-homepage" class="media-group active">
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchMediaSub('homepage','hero')">Hero</button>
                        <button class="sub-tab" onclick="switchMediaSub('homepage','works')">Works / Projects</button>
                        <button class="sub-tab" onclick="switchMediaSub('homepage','services')">Services</button>
                        <button class="sub-tab" onclick="switchMediaSub('homepage','process')">Process</button>
                        <button class="sub-tab" onclick="switchMediaSub('homepage','team')">Team</button>
                        <button class="sub-tab" onclick="switchMediaSub('homepage','faq')">FAQ</button>
                        <button class="sub-tab" onclick="switchMediaSub('homepage','footer')">Footer</button>
                    </div>
                    <div id="media-sub-homepage-hero" class="media-sub active"></div>
                    <div id="media-sub-homepage-works" class="media-sub"></div>
                    <div id="media-sub-homepage-services" class="media-sub"></div>
                    <div id="media-sub-homepage-process" class="media-sub"></div>
                    <div id="media-sub-homepage-team" class="media-sub"></div>
                    <div id="media-sub-homepage-faq" class="media-sub"></div>
                    <div id="media-sub-homepage-footer" class="media-sub"></div>
                </div>

                <!-- PAGES -->
                <div id="media-group-pages" class="media-group">
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchMediaSub('pages','lighting')">Lighting</button>
                        <button class="sub-tab" onclick="switchMediaSub('pages','audio')">Audio</button>
                        <button class="sub-tab" onclick="switchMediaSub('pages','security')">Security</button>
                        <button class="sub-tab" onclick="switchMediaSub('pages','solar')">Solar</button>
                        <button class="sub-tab" onclick="switchMediaSub('pages','about')">About</button>
                    </div>
                    <div id="media-sub-pages-lighting" class="media-sub active"></div>
                    <div id="media-sub-pages-audio" class="media-sub"></div>
                    <div id="media-sub-pages-security" class="media-sub"></div>
                    <div id="media-sub-pages-solar" class="media-sub"></div>
                    <div id="media-sub-pages-about" class="media-sub"></div>
                </div>
            </div>

            <!-- TAB: LEADS -->
            <div id="tab-leads" class="tab-pane">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Package Downloads</h3>
                    <button onclick="exportCSV()" class="btn btn-secondary">Download CSV</button>
                </div>
                <div id="leads-stats" style="margin-bottom:20px; font-weight:600; color:#111827;"></div>
                <div style="overflow-x:auto;">
                    <table id="leads-table">
                        <thead><tr><th>Date</th><th>Name</th><th>Phone</th><th>City</th><th>Purpose</th><th>Package</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://jurrmvwgtloxsukfspub.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1cnJtdndndGxveHN1a2ZzcHViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjI5ODUsImV4cCI6MjA4NjEzODk4NX0.nylOyFvsYeJZuJxwcIyfiwNOQHyL0YOV3uXcnHGr9LY';

    if (!window.supabase || !window.supabase.createClient) {
        alert("Supabase library failed to load.");
        throw new Error("Supabase UMD not available");
    }
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');

    function setLoginLoading(isLoading) {
        const btn = loginForm.querySelector('button[type="submit"]');
        if (!btn) return;
        btn.disabled = isLoading;
        btn.textContent = isLoading ? "Signing In..." : "Sign In";
    }
    function showLogin() { loginView.style.display = 'block'; dashboardView.style.display = 'none'; }
    function showDashboard() {
        loginView.style.display = 'none';
        dashboardView.style.display = 'block';
        loadContent(); loadProjects(); loadTeam(); loadLeads();
    }

    supabaseClient.auth.onAuthStateChange((_event, session) => {
        if (session) showDashboard(); else showLogin();
    });

    async function initAuth() {
        try {
            const { data, error } = await supabaseClient.auth.getSession();
            if (error) throw error;
            if (data.session) showDashboard(); else showLogin();
        } catch (e) {
            loginError.textContent = e?.message || 'Session check failed.';
            showLogin();
        }
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = "";
        setLoginLoading(true);
        try {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            if (!data.session) throw new Error('No session returned.');
            showDashboard();
        } catch (err) {
            loginError.textContent = err?.message || "Login failed.";
            showLogin();
        } finally { setLoginLoading(false); }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => { await supabaseClient.auth.signOut(); });

    // --- TABS ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        const tabs = ['content','projects','team','media','leads'];
        const btns = document.querySelectorAll('.nav-btn');
        const idx = tabs.indexOf(tabName);
        if (idx >= 0 && btns[idx]) btns[idx].classList.add('active');
        if (tabName === 'media') loadMediaRegistry();
    };

    // --- SITE CONTENT ---
    async function loadContent() {
        const container = document.getElementById('content-list');
        container.innerHTML = 'Loading...';
        const { data, error } = await supabaseClient.from('site_content').select('*').order('key');
        if (error) { container.innerHTML = 'Error: ' + error.message; return; }
        container.innerHTML = '';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'content-row';
            div.innerHTML = '<div><label>' + (item.description || item.key) + '</label><div class="content-key">' + item.key + '</div></div><div>' +
                (item.type === 'video'
                    ? '<input type="text" id="val-' + item.key + '" value="' + (item.value||'').replace(/"/g,'&quot;') + '" placeholder="Video URL">'
                    : '<textarea id="val-' + item.key + '" rows="2">' + (item.value || '') + '</textarea>') +
                '</div><div><button class="btn" onclick="saveContent(\'' + item.key + '\')">Save</button></div>';
            container.appendChild(div);
        });
    }

    window.saveContent = async (key) => {
        const input = document.getElementById('val-' + key);
        const { error } = await supabaseClient.from('site_content').update({ value: input.value }).eq('key', key);
        if (error) alert('Error: ' + error.message); else alert('Saved!');
    };

    // --- PROJECTS ---
    async function loadProjects() {
        const container = document.getElementById('project-list');
        container.innerHTML = 'Loading...';
        const { data, error } = await supabaseClient.from('projects').select('*').order('display_order', { ascending: true });
        if (error) { container.innerHTML = 'Error: ' + error.message; return; }
        container.innerHTML = '';
        if (!data.length) { container.innerHTML = '<p>No projects yet.</p>'; return; }
        data.forEach(p => {
            container.innerHTML += '<div class="item-card"><img src="' + (p.image_url||'') + '"><div class="item-details"><h4>' + (p.title||'') + '</h4><p>' + (p.description||'') + '</p></div><div class="actions"><button class="btn btn-danger" onclick="deleteItem(\'projects\',\'' + p.id + '\')">Delete</button></div></div>';
        });
    }

    document.getElementById('add-project-btn').addEventListener('click', async (e) => {
        const btn = e.target;
        const title = document.getElementById('p-title').value.trim();
        const desc = document.getElementById('p-desc').value.trim();
        const link = document.getElementById('p-link').value.trim();
        const file = document.getElementById('p-file').files[0];
        if (!title || !file) return alert('Title and Image are required');
        btn.textContent = 'Uploading...'; btn.disabled = true;
        try {
            const fileExt = (file.name.split('.').pop() || 'png').toLowerCase();
            const fileName = 'projects/' + Date.now() + '.' + fileExt;
            const { error: upErr } = await supabaseClient.storage.from('homepage-images').upload(fileName, file, { upsert: false });
            if (upErr) throw upErr;
            const imageUrl = SUPABASE_URL + '/storage/v1/object/public/homepage-images/' + fileName;
            const { error: dbErr } = await supabaseClient.from('projects').insert([{ title: title, description: desc, link_url: link, image_url: imageUrl, display_order: Date.now() }]);
            if (dbErr) throw dbErr;
            document.getElementById('p-title').value = '';
            document.getElementById('p-desc').value = '';
            document.getElementById('p-link').value = '';
            document.getElementById('p-file').value = '';
            await loadProjects();
            alert('Project added!');
        } catch (err) { alert('Error: ' + (err?.message || err)); }
        finally { btn.textContent = 'Add Project'; btn.disabled = false; }
    });

    // --- TEAM ---
    async function loadTeam() {
        const container = document.getElementById('team-list');
        container.innerHTML = 'Loading...';
        const { data, error } = await supabaseClient.from('team_members').select('*').order('display_order', { ascending: true });
        if (error) { container.innerHTML = 'Error: ' + error.message; return; }
        container.innerHTML = '';
        if (!data.length) { container.innerHTML = '<p>No team members yet.</p>'; return; }
        data.forEach(t => {
            container.innerHTML += '<div class="item-card"><img src="' + (t.image_url||'') + '"><div class="item-details"><h4>' + (t.name||'') + '</h4><p>' + (t.role||'') + '</p></div><div class="actions"><button class="btn btn-danger" onclick="deleteItem(\'team_members\',\'' + t.id + '\')">Delete</button></div></div>';
        });
    }

    document.getElementById('add-team-btn').addEventListener('click', async (e) => {
        const btn = e.target;
        const name = document.getElementById('t-name').value.trim();
        const role = document.getElementById('t-role').value.trim();
        const file = document.getElementById('t-file').files[0];
        if (!name || !file) return alert('Name and Photo are required');
        btn.textContent = 'Uploading...'; btn.disabled = true;
        try {
            const fileExt = (file.name.split('.').pop() || 'png').toLowerCase();
            const fileName = 'team/' + Date.now() + '.' + fileExt;
            const { error: upErr } = await supabaseClient.storage.from('pages-images').upload(fileName, file, { upsert: false });
            if (upErr) throw upErr;
            const imageUrl = SUPABASE_URL + '/storage/v1/object/public/pages-images/' + fileName;
            const { error: dbErr } = await supabaseClient.from('team_members').insert([{ name: name, role: role, image_url: imageUrl, display_order: Date.now() }]);
            if (dbErr) throw dbErr;
            document.getElementById('t-name').value = '';
            document.getElementById('t-role').value = '';
            document.getElementById('t-file').value = '';
            await loadTeam();
            alert('Team member added!');
        } catch (err) { alert('Error: ' + (err?.message || err)); }
        finally { btn.textContent = 'Add Member'; btn.disabled = false; }
    });

    // --- DELETE ---
    window.deleteItem = async (table, id) => {
        if (!confirm('Delete this item?')) return;
        const { error } = await supabaseClient.from(table).delete().eq('id', id);
        if (error) alert('Error: ' + error.message);
        else { if (table === 'projects') loadProjects(); if (table === 'team_members') loadTeam(); }
    };

    // =============================================
    // SECTION-BASED MEDIA MANAGER
    // =============================================

    const MEDIA_REGISTRY = {
        homepage: {
            hero: [
                { key: 'hero_video', label: 'Hero Background Video', bucket: 'hero-assets', accept: 'video/*', storagePath: 'hero_video.mp4' },
                { key: 'hero_background', label: 'Hero Fallback Image', bucket: 'hero-assets', accept: 'image/*', storagePath: 'hero_bg.jpg' },
            ],
            works: [], // managed via Projects tab
            services: [
                { key: 'svc_thumb_lighting', label: 'Smart Lighting Thumbnail', bucket: 'homepage-images', accept: 'image/*' },
                { key: 'svc_thumb_audio', label: 'Home Audio Thumbnail', bucket: 'homepage-images', accept: 'image/*' },
                { key: 'svc_thumb_security', label: 'CCTV & Security Thumbnail', bucket: 'homepage-images', accept: 'image/*' },
                { key: 'svc_thumb_solar', label: 'Solar & Power Thumbnail', bucket: 'homepage-images', accept: 'image/*' },
            ],
            process: [
                { key: 'process_image', label: 'Engineering Process Image', bucket: 'homepage-images', accept: 'image/*' },
            ],
            team: [], // managed via Team tab
            faq: [], // no images
            footer: [
                { key: 'experience_image', label: 'Full-Width Experience Image', bucket: 'homepage-images', accept: 'image/*' },
                { key: 'footer_cta_bg', label: 'Footer CTA Background', bucket: 'homepage-images', accept: 'image/*' },
            ],
        },
        pages: {
            lighting: [
                { key: 'lighting_hero', label: 'Page Hero Image', bucket: 'pages-images', accept: 'image/*' },
                { key: 'lighting_grid_1', label: 'Grid Card â€” Morning', bucket: 'pages-images', accept: 'image/*' },
                { key: 'lighting_grid_2', label: 'Grid Card â€” Afternoon', bucket: 'pages-images', accept: 'image/*' },
                { key: 'lighting_grid_3', label: 'Grid Card â€” Evening', bucket: 'pages-images', accept: 'image/*' },
                { key: 'lighting_zigzag_1', label: 'Zigzag â€” Auto Day-to-Night', bucket: 'pages-images', accept: 'image/*' },
                { key: 'lighting_zigzag_2', label: 'Zigzag â€” Clean Walls', bucket: 'pages-images', accept: 'image/*' },
                { key: 'lighting_usp', label: 'USP Interface Image', bucket: 'pages-images', accept: 'image/*' },
            ],
            audio: [
                { key: 'audio_hero', label: 'Page Hero Image', bucket: 'pages-images', accept: 'image/*' },
                { key: 'audio_gallery_1', label: 'Gallery â€” Private Cinema', bucket: 'pages-images', accept: 'image/*' },
                { key: 'audio_gallery_2', label: 'Gallery â€” Living Room', bucket: 'pages-images', accept: 'image/*' },
                { key: 'audio_gallery_3', label: 'Gallery â€” Outdoor', bucket: 'pages-images', accept: 'image/*' },
                { key: 'audio_statement', label: 'Statement Section Image', bucket: 'pages-images', accept: 'image/*' },
            ],
            security: [
                { key: 'security_hero', label: 'Page Hero Image', bucket: 'pages-images', accept: 'image/*' },
                { key: 'security_quad_1', label: 'Quad Grid â€” Entrance', bucket: 'pages-images', accept: 'image/*' },
                { key: 'security_quad_2', label: 'Quad Grid â€” Perimeter', bucket: 'pages-images', accept: 'image/*' },
                { key: 'security_quad_3', label: 'Quad Grid â€” Interior', bucket: 'pages-images', accept: 'image/*' },
                { key: 'security_quad_4', label: 'Quad Grid â€” Control', bucket: 'pages-images', accept: 'image/*' },
                { key: 'security_focus', label: 'Focus Section Image', bucket: 'pages-images', accept: 'image/*' },
            ],
            solar: [
                { key: 'solar_hero', label: 'Page Hero Image', bucket: 'pages-images', accept: 'image/*' },
                { key: 'solar_break', label: 'Break Section Image', bucket: 'pages-images', accept: 'image/*' },
            ],
            about: [
                { key: 'team_group_photo', label: 'Team Group Photo', bucket: 'pages-images', accept: 'image/*' },
            ],
        }
    };

    // Info messages for sections with no direct media
    const SECTION_NOTES = {
        'homepage-works': 'ðŸ“Œ Project images are managed in the <strong>Projects</strong> tab. Each project card has its own image upload.',
        'homepage-team': 'ðŸ“Œ Individual team member photos are managed in the <strong>Team</strong> tab. The group photo below is a separate homepage asset.',
        'homepage-faq': 'ðŸ“Œ The FAQ section contains no images or videos â€” it\'s text-only.',
    };

    let mediaContentMap = {};

    window.switchMediaGroup = function(group) {
        document.querySelectorAll('.media-group').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.media-level-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('media-group-' + group).classList.add('active');
        // Activate the right tab button
        const tabs = document.querySelectorAll('.media-level-tab');
        if (group === 'homepage') tabs[0].classList.add('active');
        else tabs[1].classList.add('active');
        // Show first sub-tab
        const firstSub = document.querySelector('#media-group-' + group + ' .sub-tab');
        if (firstSub) firstSub.click();
    };

    window.switchMediaSub = function(group, sub) {
        const container = document.getElementById('media-group-' + group);
        container.querySelectorAll('.media-sub').forEach(el => el.classList.remove('active'));
        container.querySelectorAll('.sub-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('media-sub-' + group + '-' + sub).classList.add('active');
        // Find and activate the clicked sub-tab button
        container.querySelectorAll('.sub-tab').forEach(btn => {
            if (btn.textContent.toLowerCase().includes(sub) || btn.getAttribute('onclick')?.includes("'" + sub + "'")) {
                btn.classList.add('active');
            }
        });
        renderMediaSection(group, sub);
    };

    async function loadMediaRegistry() {
        // Fetch all site_content to get current URLs
        const { data, error } = await supabaseClient.from('site_content').select('*');
        if (error) { console.error('Failed to load site_content:', error.message); return; }
        mediaContentMap = {};
        if (data) data.forEach(item => mediaContentMap[item.key] = item.value);
        // Render the currently active section
        const activeGroup = document.querySelector('.media-group.active');
        const activeSub = activeGroup ? activeGroup.querySelector('.media-sub.active') : null;
        if (activeSub) {
            const id = activeSub.id; // e.g. media-sub-homepage-hero
            const parts = id.replace('media-sub-','').split('-');
            renderMediaSection(parts[0], parts[1]);
        }
    }

    function renderMediaSection(group, sub) {
        const container = document.getElementById('media-sub-' + group + '-' + sub);
        if (!container) return;

        const noteKey = group + '-' + sub;
        const note = SECTION_NOTES[noteKey];
        const items = MEDIA_REGISTRY[group]?.[sub] || [];

        let html = '';

        if (note) {
            html += '<div class="media-info-note">' + note + '</div>';
        }

        if (items.length === 0 && !note) {
            html += '<div class="media-info-note">No editable media in this section.</div>';
            container.innerHTML = html;
            return;
        }

        items.forEach(item => {
            const currentUrl = mediaContentMap[item.key] || '';
            const isVideo = item.accept === 'video/*';
            const inputId = 'media-file-' + item.key;

            let previewHtml = '';
            if (currentUrl) {
                if (isVideo) {
                    previewHtml = '<video src="' + currentUrl + '" muted style="width:100%;height:100%;object-fit:cover;"></video>';
                } else {
                    previewHtml = '<img src="' + currentUrl + '" onerror="this.style.display=\'none\'">';
                }
            } else {
                previewHtml = '<div class="no-media">No media set</div>';
            }

            html += '<div class="media-slot">' +
                '<div class="media-slot-preview">' + previewHtml + '</div>' +
                '<div class="media-slot-info">' +
                    '<div class="media-slot-label">' + item.label + '</div>' +
                    '<div class="media-slot-key">key: ' + item.key + '</div>' +
                    '<div class="media-slot-actions">' +
                        '<input type="file" id="' + inputId + '" accept="' + item.accept + '" style="margin:0;">' +
                        '<button class="replace-btn" onclick="replaceMedia(\'' + item.key + '\',\'' + item.bucket + '\',\'' + inputId + '\',\'' + (item.storagePath || '') + '\')">Replace</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        });

        container.innerHTML = html;
    }

    window.replaceMedia = async function(key, bucket, inputId, fixedPath) {
        const fileInput = document.getElementById(inputId);
        const file = fileInput?.files[0];
        if (!file) return alert('Please select a file first.');

        const btn = fileInput.nextElementSibling;
        btn.textContent = 'Uploading...';
        btn.disabled = true;

        try {
            // Determine storage path
            const fileExt = (file.name.split('.').pop() || 'bin').toLowerCase();
            const storagePath = fixedPath || ('media/' + key + '.' + fileExt);

            // Upload (upsert to replace existing)
            const { error: upErr } = await supabaseClient.storage.from(bucket).upload(storagePath, file, { upsert: true });
            if (upErr) throw upErr;

            // Build public URL
            const publicUrl = SUPABASE_URL + '/storage/v1/object/public/' + bucket + '/' + storagePath + '?t=' + Date.now();

            // Upsert into site_content
            const { error: dbErr } = await supabaseClient.from('site_content').upsert(
                { key: key, value: publicUrl, type: file.type.startsWith('video') ? 'video' : 'image' },
                { onConflict: 'key' }
            );
            if (dbErr) throw dbErr;

            // Update local map & re-render
            mediaContentMap[key] = publicUrl;
            fileInput.value = '';

            // Re-render current section
            const activeGroup = document.querySelector('.media-group.active');
            const activeSub = activeGroup ? activeGroup.querySelector('.media-sub.active') : null;
            if (activeSub) {
                const id = activeSub.id;
                const parts = id.replace('media-sub-','').split('-');
                renderMediaSection(parts[0], parts[1]);
            }

            alert('âœ… Media replaced & linked to site!');
        } catch (err) {
            alert('Error: ' + (err?.message || err));
        } finally {
            btn.textContent = 'Replace';
            btn.disabled = false;
        }
    };

    // --- LEADS ---
    async function loadLeads() {
        const tbody = document.querySelector('#leads-table tbody');
        tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        const { data, error } = await supabaseClient.from('leads').select('*').order('created_at', { ascending: false });
        if (error) return;
        tbody.innerHTML = '';
        document.getElementById('leads-stats').innerText = 'Total Downloads: ' + data.length;
        data.forEach(l => {
            var date = new Date(l.created_at).toLocaleDateString();
            var bc = l.package_type === 'tuya' ? 'badge-tuya' : 'badge-orvibo';
            tbody.innerHTML += '<tr><td>' + date + '</td><td>' + l.full_name + '</td><td>' + l.phone + '</td><td>' + (l.city||'-') + '</td><td>' + (l.purpose||'-') + '</td><td><span class="badge ' + bc + '">' + (l.package_type||'Unknown') + '</span></td></tr>';
        });
    }

    window.exportCSV = async () => {
        const { data } = await supabaseClient.from('leads').select('*');
        if (!data || !data.length) return alert('No data to export');
        var headers = ['ID','Date','Name','Phone','City','Purpose','Package'];
        var rows = data.map(function(l) { return [l.id, l.created_at, l.full_name, l.phone, l.city, l.purpose, l.package_type]; });
        var csv = [headers.join(',')].concat(rows.map(function(e) { return e.join(','); })).join('\n');
        var blob = new Blob([csv], { type: 'text/csv' });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "gidatech_leads.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    initAuth();
    </script>
</body>
</html>
